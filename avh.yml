name: "Build and run AWS MQTT Demo on Arm Virtual Hardware"
workdir: ./
backend:
  aws:
    ami-version: ~=1.3.0
    instance-type: t2.large
upload:
  - amazon-freertos/**/*
  - config_files/**/*
  - framework/interface/**/*
  - framework/layer/Board/AVH_MPS3_Corstone-300/IoT/**/*
  - framework/layer/Socket/VSocket/**/*
  - RTE/**/*
  - .cdefault.yml
  - app_main.c
  - Demo.*.yml
  - README.md
  - cmsis-toolbox.sh
steps:
  - run: |
      [ -f cmsis-toolbox.sh ] || wget https://github.com/Open-CMSIS-Pack/cmsis-toolbox/releases/download/1.5.0/cmsis-toolbox.sh
      chmod +x cmsis-toolbox.sh
      sudo ./cmsis-toolbox.sh <<EOI
      /opt/ctools
      $CMSIS_PACK_ROOT
      $(dirname $(which armclang 2>/dev/null))
      $(dirname $(which armcc 2>/dev/null))
      $(dirname $(which arm-none-eabi-gcc 2>/dev/null))
      EOI
      echo "cpackget : $(which cpackget)"
      echo "csolution: $(which csolution)"
      echo "cbuild   : $(which cbuild)"
  - run: |
      echo ">csolution -s Demo.csolution.yml -c Demo.Debug+AVH_MPS3_Corstone-300 list packs -m >packlist"
      csolution -s Demo.csolution.yml -c Demo.Debug+AVH_MPS3_Corstone-300 list packs -m >packlist
      echo ">cpackget add -f packlist -a"
      cpackget add -f packlist -a
      echo ">csolution convert -s Demo.csolution.yml -c Demo.Debug+AVH_MPS3_Corstone-300"
      csolution convert -s Demo.csolution.yml -c Demo.Debug+AVH_MPS3_Corstone-300
      echo ">cbuild Demo.Debug+AVH_MPS3_Corstone-300.cprj"
      cbuild Demo.Debug+AVH_MPS3_Corstone-300.cprj
      echo ">VHT_MPS3_Corstone_SSE-300 -f framework/layer/Board/AVH_MPS3_Corstone-300/IoT/fvp_config.txt --stat --simlimit 600 out/Demo/AVH_MPS3_Corstone-300/Debug/Debug+AVH_MPS3_Corstone-300.axf"
      VHT_MPS3_Corstone_SSE-300 -f framework/layer/Board/AVH_MPS3_Corstone-300/IoT/fvp_config.txt --stat --simlimit 600 out/Demo/AVH_MPS3_Corstone-300/Debug/Debug+AVH_MPS3_Corstone-300.axf >Demo.log
      cat Demo.log
download:
  - Demo.log
